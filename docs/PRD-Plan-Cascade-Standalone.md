# Plan Cascade Standalone - 产品需求文档 (PRD)

**版本**: 4.0.0
**日期**: 2026-01-29
**作者**: Plan Cascade Team
**状态**: Implementation In Progress

---

## 实现状态总览

> **当前进度**: ~98% 核心功能已实现
> **最后更新**: 2026-01-29

### 功能需求实现状态

| 功能 (章节) | 优先级 | 状态 | 说明 |
|-------------|--------|------|------|
| **4.1 工作模式选择** | P0 | ✅ 已完成 | |
| 独立编排模式 | P0 | ✅ 已完成 | ReAct 引擎 + 工具执行 |
| Claude Max LLM 后端 | P0 | ✅ 已完成 | `llm/providers/claude_max.py` |
| Claude API | P0 | ✅ 已完成 | `llm/providers/claude.py` |
| OpenAI | P0 | ✅ 已完成 | `llm/providers/openai.py` |
| DeepSeek | P1 | ✅ 已完成 | `llm/providers/deepseek.py` |
| Ollama | P2 | ✅ 已完成 | `llm/providers/ollama.py` |
| **4.2 多 Agent 协同** | P0 | ✅ 已完成 | |
| 基于阶段的 Agent 分配 | P0 | ✅ 已完成 | `backends/phase_config.py` |
| Agent 执行器 | P0 | ✅ 已完成 | `backends/agent_executor.py` |
| **4.2 简单模式功能** | P0 | ✅ 已完成 | |
| 一键式工作流 | P0 | ✅ 已完成 | `core/simple_workflow.py` |
| AI 自动策略判断 | P0 | ✅ 已完成 | `core/strategy_analyzer.py` |
| **4.3 专家模式功能** | P0 | ✅ 已完成 | |
| PRD 编辑器 | P0 | ✅ 已完成 | `core/expert_workflow.py` |
| 执行策略选择 | P0 | ✅ 已完成 | direct/hybrid/mega |
| Agent 指定 | P0 | ✅ 已完成 | 每个 Story 可指定 Agent |
| **4.4 设置页面** | P0 | ✅ 已完成 | |
| Agent 配置 | P0 | ✅ 已完成 | `settings/models.py` |
| 质量门控配置 | P0 | ✅ 已完成 | `core/quality_gate.py` |
| API Key 安全存储 | P0 | ✅ 已完成 | Keyring 集成 |
| **4.5 CLI 功能** | P1 | ✅ 已完成 | |
| `plan-cascade run` | P0 | ✅ 已完成 | 简单/专家模式 |
| `plan-cascade config` | P0 | ✅ 已完成 | 配置向导 |
| `plan-cascade status` | P1 | ✅ 已完成 | 状态查看 |
| **4.6 Claude Code GUI 模式** | P0 | ⚠️ 部分完成 | |
| Claude Code CLI 集成 | P0 | ✅ 已完成 | `backends/claude_code.py` |
| GUI 专用后端 | P2 | ⏳ 规划中 | `backends/claude_code_gui.py` |
| 工具调用可视化 | P1 | ✅ 已完成 | 流式事件解析 |
| **4.7 交互式 REPL 模式** | P0 | ✅ 已完成 | |
| REPL 循环 | P0 | ✅ 已完成 | `plan-cascade chat` |
| 特殊命令 | P0 | ✅ 已完成 | /exit, /clear, /status, /mode |
| 智能意图识别 | P0 | ✅ 已完成 | `core/intent_classifier.py` |

### 产品形态实现状态

| 形态 | 状态 | 说明 |
|------|------|------|
| CLI | ✅ 已完成 | `pip install plan-cascade` |
| Desktop (GUI) | ⏳ 规划中 | Tauri 实现，Phase 2 目标 |
| Claude Code Plugin | ✅ 已完成 | 现有 Plugin 保持兼容 |

### 里程碑进度

| 阶段 | 状态 | 完成度 |
|------|------|--------|
| Phase 1: CLI + 双模式 | ✅ 已完成 | 100% |
| Phase 2: 桌面应用 Alpha | ⏳ 规划中 | 0% |
| Phase 3: 功能完善 | ⏳ 待开始 | - |
| Phase 4: 高级功能 | ⏳ 待开始 | - |

---

## 1. 概述

### 1.1 产品愿景

将 Plan Cascade 发展为一个**完整的 AI 编程编排平台**，具备自主工具执行能力，让 AI 编程变得简单。

**核心定位**：
- 作为 **完整的编排层**：自己执行工具，LLM 只提供思考（独立模式）
- 作为 **Claude Code 的图形界面**：兼容 Claude Code 所有功能（GUI 模式）
- 支持 **多种 LLM 后端**：Claude Max、Claude API、OpenAI、DeepSeek 等

### 1.2 核心价值主张

| 价值点 | 描述 |
|--------|------|
| **完整编排能力** | 自主执行工具（Read/Write/Edit/Bash/Glob/Grep），不依赖外部 Agent |
| **零门槛使用** | Claude Max 会员无需 API Key，直接通过 Claude Code 作为 LLM 后端 |
| **双模式切换** | 简单模式快速上手，专家模式精细控制 |
| **模型自由** | 支持 Claude Max、Claude API、OpenAI、DeepSeek、Ollama 等 |
| **理念延续** | 完整保留 Plan Cascade 的核心设计理念 |
| **Claude Code 兼容** | 可作为 Claude Code 的完整 GUI，兼容所有功能 |

### 1.3 产品定位

```
┌─────────────────────────────────────────────────────────────┐
│                    Plan Cascade                              │
│          完整的 AI 编程编排平台 + Claude Code GUI             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌─ 工作模式选择 ─────────────────────────────────────────┐│
│   │                                                        ││
│   │  ● 独立编排模式（推荐）                                ││
│   │    └─ Plan Cascade 执行所有工具                       ││
│   │    └─ LLM 只提供思考（支持 Claude Max/API/OpenAI 等）  ││
│   │                                                        ││
│   │  ○ Claude Code GUI 模式                                ││
│   │    └─ 作为 Claude Code 的图形界面                      ││
│   │    └─ Claude Code 执行工具，Plan Cascade 提供可视化    ││
│   │                                                        ││
│   └────────────────────────────────────────────────────────┘│
│                                                              │
│   ┌─ 独立编排模式：LLM 后端选择 ───────────────────────────┐│
│   │                                                        ││
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   ││
│   │   │ Claude Max  │  │ Claude API  │  │   OpenAI    │   ││
│   │   │ (无需API Key)│  │ (需API Key) │  │ (需API Key) │   ││
│   │   │ 通过Claude  │  │  直接调用   │  │  直接调用   │   ││
│   │   │ Code获取LLM │  │             │  │             │   ││
│   │   └─────────────┘  └─────────────┘  └─────────────┘   ││
│   │                                                        ││
│   └────────────────────────────────────────────────────────┘│
│                                                              │
└─────────────────────────────────────────────────────────────┘

独立编排模式：Plan Cascade = 完整编排 + 工具执行 + LLM 思考
Claude Code GUI 模式：Plan Cascade = Claude Code 的可视化界面
```

### 1.4 目标用户

| 用户群体 | 场景 | 痛点 | 解决方案 |
|----------|------|------|----------|
| **Claude Max 会员** | 有 Max 订阅但无 API Key | Claude Code Plugin 使用复杂 | 独立编排模式 + Claude Code LLM 后端 |
| **新手开发者** | 想用 AI 辅助开发 | Claude Code CLI 学习成本高 | 简单模式一键完成 |
| **资深开发者** | 需要精细控制 | 现有工具控制力不足 | 专家模式自定义 |
| **小型团队** | 统一工具链 | 不同成员用不同 LLM | 多后端支持 |
| **企业用户** | 数据安全要求 | 需要私有部署 | 支持本地模型 |

---

## 2. 核心设计理念

### 2.1 易用性优先

**设计原则**：用户只需描述想做什么，系统自动处理一切。

```
用户输入
   │
   ▼
"帮我做一个用户登录功能，要支持 OAuth 和手机验证码"
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│                    Plan Cascade 自动处理                     │
│                                                              │
│   ✓ 判断任务规模 → 自动选择执行策略                         │
│   ✓ 生成 PRD 和 Stories                                     │
│   ✓ 分析依赖关系 → 安排执行批次                             │
│   ✓ 选择合适的 Agent                                        │
│   ✓ 并行执行任务                                            │
│   ✓ 自动质量检查和重试                                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
完成
```

**用户不需要理解**：Mega Plan、Hybrid Ralph、Worktree、批次依赖等内部概念。

### 2.2 双模式设计

#### 简单模式（默认）

面向：新手用户、快速任务

```
┌─ 简单模式 ──────────────────────────────────────────────────┐
│                                                              │
│   描述你想要实现的功能：                                     │
│   ┌────────────────────────────────────────────────────────┐│
│   │ 实现用户登录功能，支持 OAuth 和手机验证码               ││
│   └────────────────────────────────────────────────────────┘│
│                                                              │
│                              [开始] ← 一键启动，自动完成全部 │
│                                                              │
│  ────────────────────────────────────────────────────────── │
│                                                              │
│   执行中...                                                  │
│   ┌────────────────────────────────────────────────────────┐│
│   │ ✓ 生成计划 (5 个任务)                                  ││
│   │ ✓ Batch 1: 数据库 Schema, API 路由 (2/2)               ││
│   │ ⟳ Batch 2: OAuth 登录, 手机验证码 (1/2)                ││
│   │ ○ Batch 3: 集成测试                                    ││
│   └────────────────────────────────────────────────────────┘│
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

#### 专家模式

面向：资深用户、需要精细控制

```
┌─ 专家模式 ──────────────────────────────────────────────────┐
│                                                              │
│  ┌─ Step 1: 需求输入 ──────────────────────────────────────┐│
│  │ 实现用户登录功能，支持 OAuth 和手机验证码               ││
│  └────────────────────────────────────────────────────────┘│
│                                            [生成 PRD]       │
│                                                              │
│  ┌─ Step 2: Review PRD ────────────────────────────────────┐│
│  │                                                          ││
│  │  执行策略:                        AI 建议: Hybrid Auto  ││
│  │  ○ 直接执行   ● Hybrid Auto   ○ Mega Plan              ││
│  │                                                          ││
│  │  □ 使用 Git Worktree 隔离开发                           ││
│  │                                                          ││
│  │  Stories:                                    [+ 添加]   ││
│  │  ┌────────────────────────────────────────────────────┐ ││
│  │  │ □ 设计数据库 Schema                                │ ││
│  │  │   Priority: high  │  Agent: [claude-code ▼]        │ ││
│  │  │   Dependencies: none                    [编辑][删除]│ ││
│  │  ├────────────────────────────────────────────────────┤ ││
│  │  │ □ 实现 OAuth 登录                                  │ ││
│  │  │   Priority: medium │  Agent: [aider ▼]             │ ││
│  │  │   Dependencies: [Schema ▼]              [编辑][删除]│ ││
│  │  └────────────────────────────────────────────────────┘ ││
│  │                                                          ││
│  │  质量门控: [✓] TypeCheck  [✓] Test  [✓] Lint  [ ] Custom ││
│  │                                                          ││
│  └──────────────────────────────────────────────────────────┘│
│                                                              │
│                              [保存草稿]  [开始执行]          │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

#### 模式对比

| 功能 | 简单模式 | 专家模式 |
|------|----------|----------|
| 需求输入 | ✓ | ✓ |
| 自动生成 PRD | ✓ (直接执行) | ✓ (可编辑) |
| Review/编辑 PRD | ✗ | ✓ |
| 选择执行策略 | ✗ (AI 自动) | ✓ |
| 指定 Agent | ✗ (自动) | ✓ |
| 调整依赖关系 | ✗ | ✓ |
| 自定义质量门控 | ✗ (使用默认) | ✓ |
| 执行监控 | 简化视图 | 详细视图 |
| 日志查看 | 仅错误 | 完整日志 |

### 2.3 AI 自动判断执行策略

简单模式下，AI 根据用户需求自动选择最佳执行策略：

```
用户输入                              AI 判断                    内部执行
───────────────────────────────────────────────────────────────────────────
"添加一个退出按钮"            →   小任务              →   直接执行（无 PRD）

"实现用户登录功能"            →   中等功能            →   Hybrid Auto
                                                          (自动生成 PRD)

"开发一个博客系统，           →   大型项目            →   Mega Plan
 包含用户、文章、评论"                                    (多 PRD 级联)

"重构支付模块，               →   需要隔离            →   Hybrid Worktree
 不要影响现有功能"                                        (Git 隔离开发)
```

**判断维度**：
1. **任务规模**：单一任务 / 多功能 / 完整项目
2. **复杂度**：是否需要分解为多个 Stories
3. **风险程度**：是否需要隔离开发
4. **依赖关系**：是否有跨模块依赖

### 2.4 核心架构理念（必须保留）

#### 层层分解

```
项目 (Mega Plan)
   │
   ├── 功能1 (Hybrid Ralph / PRD)
   │      ├── Story 1.1
   │      ├── Story 1.2
   │      └── Story 1.3
   │
   └── 功能2 (Hybrid Ralph / PRD)
          ├── Story 2.1
          └── Story 2.2
```

#### 并行执行

```
批次1: [Story A, Story B, Story C]  ← 无依赖，并行执行
           ↓ 全部完成
批次2: [Story D, Story E]           ← 依赖批次1，并行执行
           ↓ 全部完成
批次3: [Story F]                    ← 依赖批次2
```

#### 多 Agent 协作

- 根据任务类型自动选择最优 Agent
- 支持 Agent 降级链（主 Agent 不可用时自动切换）
- 支持阶段化 Agent 配置

#### 质量保障

- **质量门控**: typecheck、test、lint、custom
- **智能重试**: 失败后自动重试，注入失败上下文
- **可配置**: 门控类型、重试次数均可配置

#### 状态追踪

- **基于文件的状态共享**: prd.json、.agent-status.json
- **发现共享**: findings.md 记录开发过程中的发现
- **断点恢复**: 中断后可从上次状态继续

---

## 3. 产品形态

### 3.1 三形态统一架构

```
┌─────────────────────────────────────────────────────────────┐
│                   Plan Cascade                               │
├───────────────────┬───────────────────┬─────────────────────┤
│   Desktop (GUI)   │      CLI          │  Claude Code Plugin │
├───────────────────┼───────────────────┼─────────────────────┤
│ • CLI 的图形版本  │ • 命令行操作      │ • 依赖 Claude Code   │
│ • 简单/专家模式   │ • 简单/专家模式   │ • 作为插件运行       │
│ • 交互式 REPL     │ • 交互式 REPL     │ • Slash 命令调用     │
│ • Claude Code     │ • pip install     │                     │
│   GUI 模式可选    │   plan-cascade    │                     │
└───────────────────┴───────────────────┴─────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Plan Cascade Core                          │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 工具执行引擎  │  │ ReAct 循环   │  │ PRD 生成器   │       │
│  │ Read/Write   │  │ Think→Act   │  │ 策略分析     │       │
│  │ Edit/Bash    │  │ →Observe    │  │ 批次编排     │       │
│  │ Glob/Grep    │  │             │  │              │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│                           │                                  │
│                           ▼                                  │
│           ┌─────────────────────────────┐                   │
│           │      LLM 抽象层             │                   │
│           │  Claude Max | API | OpenAI  │                   │
│           └─────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 Desktop 定位

**Desktop = CLI 的 GUI 版本**

Desktop 提供与 CLI 完全相同的功能，以图形界面呈现：
- 可视化的需求输入和执行监控
- PRD 编辑器（拖拽、依赖关系可视化）
- 实时工具调用展示
- 文件变更预览

**可选：Claude Code GUI 模式**

Desktop 可作为 Claude Code 的完整图形界面：
- 对话视图（与 Claude Code 交互）
- 工具调用可视化
- 兼容 Claude Code 所有功能

### 3.3 发布产物

| 产物 | 说明 | 目标用户 |
|------|------|----------|
| **Desktop** | Windows/macOS/Linux 安装包 | 希望图形界面的用户 |
| **CLI** | `pip install plan-cascade` | 喜欢命令行的开发者 |
| **Claude Code Plugin** | 现有 Plugin (保持兼容) | Claude Code 深度用户 |
| **Python 包** | `plan-cascade-core` | 集成到其他工具的开发者 |

---

## 4. 功能需求

### 4.1 工作模式选择 (P0)

#### 独立编排模式（推荐）

Plan Cascade 作为完整的编排层，自己执行所有工具：

```
┌─ 设置 ──────────────────────────────────────────────────────┐
│                                                              │
│  工作模式：                                                  │
│                                                              │
│  ● 独立编排模式（推荐）                                      │
│    └─ Plan Cascade 自己执行所有工具（Read/Write/Edit/Bash） │
│    └─ LLM 只提供思考，Plan Cascade 执行动作                 │
│    └─ 支持完整的 PRD 驱动开发流程                           │
│                                                              │
│  ○ Claude Code GUI 模式                                      │
│    └─ Plan Cascade 作为 Claude Code 的图形界面              │
│    └─ Claude Code 执行工具，Plan Cascade 提供可视化         │
│    └─ 兼容 Claude Code 所有功能                              │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

#### 独立编排模式：LLM 后端选择

```
┌─ LLM 后端选择 ───────────────────────────────────────────────┐
│                                                              │
│  ● Claude Max（无需 API Key）                                │
│    └─ 通过本地 Claude Code 获取 LLM 能力                    │
│    └─ 适合：已购买 Claude Max 但无 API Key 的用户           │
│                                                              │
│  ○ Claude API                                                │
│    └─ 直接调用 Anthropic API                                 │
│    └─ 需要配置 API Key                                       │
│                                                              │
│  ○ OpenAI                                                    │
│    └─ 使用 GPT-4o 等模型                                     │
│    └─ 需要配置 API Key                                       │
│                                                              │
│  ○ DeepSeek                                                  │
│    └─ 国内用户推荐                                           │
│    └─ 需要配置 API Key                                       │
│                                                              │
│  ○ Ollama                                                    │
│    └─ 本地模型，完全离线                                     │
│    └─ 需要配置 Ollama 地址                                   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**两种工作模式的本质区别**：

| | 独立编排模式 | Claude Code GUI 模式 |
|---|---|---|
| **编排层** | Plan Cascade | Plan Cascade |
| **工具执行** | Plan Cascade 自己执行 | Claude Code 执行 |
| **LLM 来源** | 多种（Claude Max/API/OpenAI 等） | Claude Code |
| **PRD 驱动** | ✅ 支持 | ✅ 支持 |
| **批次执行** | ✅ 支持 | ✅ 支持 |
| **适用场景** | 需要其他 LLM 或离线使用 | 有 Claude Max/Code 订阅 |

**核心理念：Plan Cascade = 大脑（编排），执行层 = 手（工具执行）**

两种模式都由 Plan Cascade 控制编排流程（PRD 生成、依赖分析、批次调度），区别只在于谁执行工具：
- 独立模式：Plan Cascade 内置工具引擎执行
- GUI 模式：Claude Code CLI 执行

#### 独立编排模式：Claude Max LLM 后端原理

对于购买了 Claude Max 但没有 API Key 的用户：

```
┌─────────────────────────────────────────────────────────────┐
│                    独立编排模式                              │
│              Claude Max LLM 后端                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   Plan Cascade                      Claude Code (后台)       │
│   ┌────────────┐                   ┌────────────┐           │
│   │ 编排引擎   │                   │            │           │
│   │ ──────────│                   │ 只提供     │           │
│   │ PRD 生成  │ ─── prompt ────→  │ LLM 思考   │           │
│   │ 策略分析  │ ←── response ───  │            │           │
│   │ 批次执行  │                   │ (禁用工具) │           │
│   └────────────┘                   └────────────┘           │
│        │                                                    │
│        ▼                                                    │
│   ┌────────────┐                                            │
│   │ 工具执行   │  Plan Cascade 自己执行                     │
│   │ ──────────│                                            │
│   │ Read/Write │                                            │
│   │ Edit/Bash  │                                            │
│   │ Glob/Grep  │                                            │
│   └────────────┘                                            │
│                                                              │
└─────────────────────────────────────────────────────────────┘

关键：Claude Code 只作为 LLM 后端，不执行工具
```

#### 支持的 LLM 后端

| 后端 | 优先级 | 需要 API Key | 说明 |
|------|--------|--------------|------|
| Claude Max | P0 | 否 | 通过 Claude Code 获取 LLM，适合 Max 会员 |
| Claude API | P0 | 是 | 直接调用 Anthropic API |
| OpenAI | P0 | 是 | GPT-4o 等模型 |
| DeepSeek | P1 | 是 | 国内用户 |
| Ollama | P2 | 否 | 本地模型 |

### 4.2 多 Agent 协同 (P0)

Plan Cascade 支持多种 Agent 协同工作，智能分配不同任务给最适合的 Agent：

#### 支持的执行 Agent

| Agent | 类型 | 说明 |
|-------|------|------|
| claude-code | Task Tool / CLI | 默认 Agent，内置或通过 Claude Code CLI |
| codex | CLI | OpenAI Codex CLI |
| aider | CLI | AI 结对编程助手 |
| amp-code | CLI | Amp Code CLI |
| cursor-cli | CLI | Cursor CLI |

#### 基于阶段的 Agent 分配

```
┌─────────────────────────────────────────────────────────────┐
│                    多 Agent 协同                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   执行阶段              默认 Agent        回退链             │
│   ─────────────────────────────────────────────────────────  │
│   Planning (规划)       codex           → claude-code        │
│   Implementation (实现)  claude-code     → codex → aider     │
│   Retry (重试)          claude-code     → aider              │
│   Refactor (重构)       aider           → claude-code        │
│   Review (审查)         claude-code     → codex              │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   Story 类型            默认 Agent                           │
│   ─────────────────────────────────────────────────────────  │
│   feature (功能)        claude-code                          │
│   bugfix (修复)         codex                                │
│   refactor (重构)       aider                                │
│   test (测试)           claude-code                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### Agent 解析优先级

```
1. --agent 命令参数 (显式覆盖)
2. 阶段特定参数 (--impl-agent, --planning-agent)
3. Story 中指定的 agent
4. Story 类型覆盖 (bugfix → codex, refactor → aider)
5. 阶段默认 Agent
6. 回退链 (如果 Agent 不可用)
7. claude-code (终极回退，始终可用)
```

#### 配置文件 (agents.json)

```json
{
  "default_agent": "claude-code",
  "agents": {
    "claude-code": {"type": "task-tool"},
    "codex": {"type": "cli", "command": "codex"},
    "aider": {"type": "cli", "command": "aider"}
  },
  "phase_defaults": {
    "implementation": {
      "default_agent": "claude-code",
      "fallback_chain": ["codex", "aider"],
      "story_type_overrides": {"refactor": "aider", "bugfix": "codex"}
    }
  }
}
```

**两种模式下的多 Agent 支持**：

| 模式 | Agent 类型 | 说明 |
|------|-----------|------|
| 独立编排模式 | 内置 ReAct + CLI Agents | 内置引擎作为默认，可调用外部 CLI Agent |
| Claude Code GUI 模式 | Claude Code + CLI Agents | Claude Code 作为默认，可调用外部 CLI Agent |

### 4.2 简单模式功能 (P0)

#### 一键式工作流

```bash
# CLI
plan-cascade "实现用户登录功能，支持 OAuth"
# 自动完成：分析 → 生成计划 → 执行 → 质量检查

# GUI
# 输入描述 → 点击"开始" → 等待完成
```

#### 简化状态展示

```
执行中...

[████████████░░░░░░░░] 60%

✓ 生成计划 (5 个任务)
✓ 数据库 Schema
✓ API 路由结构
⟳ OAuth 登录 (执行中...)
○ 手机验证码登录
○ 集成测试
```

### 4.3 专家模式功能 (P0)

#### PRD 编辑器

- 可视化编辑 Stories
- 拖拽调整顺序
- 设置依赖关系
- 指定执行 Agent

#### 执行策略选择

```
执行策略:                           AI 建议: Hybrid Auto
○ 直接执行（简单任务，无需 PRD）
● Hybrid Auto（自动生成 PRD 并执行）
○ Mega Plan（大型项目，多个 PRD）

隔离选项:
□ 使用 Git Worktree 隔离开发
```

#### Agent 指定

每个 Story 可以指定不同的 Agent：

```
┌─ Story: 实现 OAuth 登录 ─────────────────────────────────────┐
│                                                              │
│  Agent: [claude-code ▼]                                      │
│         ├─ claude-code (推荐)                                │
│         ├─ aider                                             │
│         ├─ codex                                             │
│         └─ builtin                                           │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 4.4 设置页面 (P0)

#### Agent 配置

```
┌─ 设置 > Agent 配置 ─────────────────────────────────────────┐
│                                                              │
│  主后端（编排用）                                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ ● Claude Code（推荐，无需配置）                        │ │
│  │ ○ Claude API    [API Key: ••••••••••]                  │ │
│  │ ○ OpenAI        [API Key: ••••••••••] [Model: gpt-4o ▼]│ │
│  │ ○ DeepSeek      [API Key: ••••••••••]                  │ │
│  │ ○ Ollama        [URL: http://localhost:11434]          │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ───────────────────────────────────────────────────────────│
│                                                              │
│  执行 Agent（Story 执行用）                      [+ 添加]   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ ✓ claude-code                              [默认]      │ │
│  │   └─ 路径: claude                                      │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ ✓ aider                                    [配置]      │ │
│  │   └─ 命令: aider --model gpt-4o                        │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ □ codex (未配置)                           [配置]      │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  Agent 自动选择策略:                                         │
│  ○ 智能匹配（根据任务类型自动选择）                          │
│  ● 优先使用: [claude-code ▼]                                │
│  ○ 手动指定（每个 Story 单独选择）                          │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

#### 质量门控配置

```
┌─ 设置 > 质量门控 ───────────────────────────────────────────┐
│                                                              │
│  默认启用的检查:                                             │
│  [✓] TypeCheck (tsc / mypy / pyright)                       │
│  [✓] Test (pytest / jest / npm test)                        │
│  [✓] Lint (eslint / ruff)                                   │
│  [ ] Custom                                                  │
│                                                              │
│  自定义脚本:                                                 │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ npm run validate                                        │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  重试设置:                                                   │
│  最大重试次数: [3]                                           │
│  重试间隔: [指数退避 ▼]                                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 4.5 CLI 功能 (P1)

```bash
# 简单模式（默认）
plan-cascade "实现用户登录功能"
# 自动完成全部流程

# 专家模式
plan-cascade --expert "实现用户登录功能"

# 专家模式交互
$ plan-cascade --expert "实现用户登录"
✓ 已生成 PRD (5 个 Stories)

? 请选择操作:
  > 查看/编辑 PRD
    修改 Agent 分配
    调整依赖关系
    开始执行
    保存草稿并退出

# 分步命令
plan-cascade generate "实现用户登录"  # 只生成 PRD
plan-cascade review                    # 交互式编辑
plan-cascade run                       # 执行
plan-cascade status                    # 查看状态
```

### 4.6 Claude Code GUI 模式 (P0)

Claude Code GUI 模式下，Plan Cascade 控制编排流程，Claude Code 执行工具：

```
┌─ Plan Cascade (Claude Code GUI 模式) ───────────────────────┐
│                                                              │
│  ┌─ PRD 驱动开发 ───────────────────────────────────────┐   │
│  │                                                      │   │
│  │  ✓ Story 1: 创建数据库 Schema                        │   │
│  │  ⟳ Story 2: 实现 API 端点 (执行中...)                │   │
│  │  ○ Story 3: 添加前端表单 (等待依赖)                  │   │
│  │                                                      │   │
│  │  [Batch 1: 2/3] ████████░░░░ 66%                     │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─ Claude Code 执行 (可视化) ─────────────────────────┐    │
│  │ ✓ Read src/auth/login.py                            │    │
│  │ ✓ Read src/auth/oauth.py                            │    │
│  │ ⟳ Edit src/auth/base.py                             │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─ 文件变更预览 ──────────────────────────────────────┐    │
│  │ - old code                                          │    │
│  │ + new code                                          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Claude Code GUI 模式特点**：
- **完整支持 PRD 驱动开发**（Plan Cascade 编排，Claude Code 执行）
- **完整支持批次执行**（依赖分析、并行执行）
- 完整兼容 Claude Code 所有功能
- 工具调用可视化（Claude Code 执行）
- 文件变更实时预览
- 质量门控和重试管理

**适用场景**：
- 有 Claude Max/Code 订阅
- 需要 PRD 驱动的复杂任务分解
- 希望可视化 Claude Code 的执行过程

### 4.7 交互式 REPL 模式 (P0)

CLI 和 Desktop 都支持交互式 REPL，实现连续对话：

```
┌─ Plan Cascade REPL ─────────────────────────────────────────┐
│                                                              │
│  plan-cascade> 分析一下项目结构                              │
│                                                              │
│  [AI 分析并响应...]                                          │
│                                                              │
│  plan-cascade> 基于上面的分析，实现用户登录功能              │
│                                                              │
│  [意图识别：TASK]                                            │
│  [策略分析：hybrid_auto]                                     │
│  [生成 PRD...]                                               │
│  [执行中...]                                                 │
│                                                              │
│  plan-cascade> /status                                       │
│  当前会话：abc123                                            │
│  模式：simple                                                │
│  项目：/path/to/project                                      │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**REPL 特殊命令**：
- `/exit`, `/quit` - 退出
- `/clear` - 清空上下文
- `/status` - 查看会话状态
- `/mode [simple|expert]` - 切换模式
- `/history` - 查看对话历史
- `/config` - 配置管理

**智能意图识别**：
- 规则匹配 → LLM 分析 → 用户确认
- 自动区分 TASK / QUERY / CHAT

---

## 5. 非功能需求

### 5.1 性能要求

| 指标 | 要求 |
|------|------|
| 启动时间 | < 3 秒 |
| 内存占用 | < 500MB (空闲状态) |
| 并行 Story 数 | 支持至少 5 个并行 |
| API 超时 | 可配置，默认 5 分钟 |

### 5.2 兼容性要求

| 平台 | 最低版本 |
|------|----------|
| Windows | Windows 10 |
| macOS | macOS 11 (Big Sur) |
| Linux | Ubuntu 20.04 / 同等 |
| Python | 3.10+ (CLI/Core) |

### 5.3 安全要求

- API Key 本地加密存储
- 不上传用户代码到第三方服务（除 LLM API）
- Shell 命令执行安全检查
- 敏感文件保护（.env, credentials 等）

---

## 6. 与竞品对比

| 特性 | Plan Cascade | Claude Code CLI | Cursor | Aider |
|------|--------------|-----------------|--------|-------|
| **图形界面** | ✅ | ❌ | ✅ | ❌ |
| **CLI 支持** | ✅ | ✅ | ❌ | ✅ |
| **多 LLM 支持** | ✅ | ❌ | ❌ | ✅ |
| **任务分解** | ✅ 自动 | ❌ 手动 | ❌ | ❌ |
| **并行执行** | ✅ | ❌ | ❌ | ❌ |
| **质量门控** | ✅ | ❌ | ❌ | ⚠️ |
| **简单模式** | ✅ | ❌ | ✅ | ❌ |
| **专家模式** | ✅ | ✅ | ❌ | ✅ |
| **开箱即用** | ✅ | ⚠️ | ✅ | ⚠️ |

---

## 7. 里程碑计划

### Phase 1: CLI + 双模式

**目标**: 可独立运行的 CLI，支持简单/专家模式

**功能范围**:
- [ ] 核心包重构
- [ ] LLM Provider 抽象层
- [ ] 简单模式实现
- [ ] 专家模式实现
- [ ] AI 自动策略判断
- [ ] 基础 CLI 命令

### Phase 2: 桌面应用 Alpha

**目标**: 图形化界面

**功能范围**:
- [ ] Tauri 桌面框架
- [ ] 简单模式 UI
- [ ] 专家模式 UI
- [ ] 设置页面
- [ ] Claude Code GUI 模式

### Phase 3: 功能完善

**目标**: 生产可用

**功能范围**:
- [ ] 完整 PRD 编辑器
- [ ] 依赖关系可视化
- [ ] 更多 LLM 后端
- [ ] 自动更新

### Phase 4: 高级功能

**目标**: 差异化优势

**功能范围**:
- [ ] 多 Agent 协作
- [ ] Git Worktree 集成
- [ ] 团队协作
- [ ] 插件系统

---

## 8. 成功指标

| 指标 | 目标 |
|------|------|
| 用户上手时间 | < 5 分钟（简单模式） |
| 任务完成率 | > 80%（简单任务） |
| 用户留存 | 30% (月活跃) |
| GitHub Stars | 1000+ (6个月内) |

---

## 9. 附录

### 9.1 术语表（用户手册中可隐藏）

| 术语 | 定义 | 用户是否需要理解 |
|------|------|-----------------|
| Mega Plan | 项目级别的规划 | 专家模式可选 |
| Hybrid Ralph | PRD 驱动的开发模式 | 专家模式可选 |
| Story | 最小可执行任务 | 专家模式需要 |
| Batch | 可并行执行的任务集合 | 不需要 |
| Quality Gate | 质量检查 | 设置中可配置 |
| BuiltinAgent | 内置 Agent | 不需要 |

### 9.2 简单模式 vs 专家模式 快速参考

```
简单模式适合：
✓ 新手用户
✓ 快速原型
✓ 单一功能开发
✓ 不想配置的场景

专家模式适合：
✓ 资深开发者
✓ 复杂项目
✓ 需要精细控制
✓ 多人协作
```
